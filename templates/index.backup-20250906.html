<html lang="ja"> <頭> <メタ文字セット="utf-8" /> <meta name="viewport" content="width=device-width,initial-scale=1" /> <title>CareBot v2</title> <!-- 基本スタイル(見やすい大きめUI) - > <スタイル> :ルート{ --bg:#f7f7fb;--カード:#fff;--インク:#111;--サブ:#666;--pri:#2f6feb; --bd:#e5e7eb;--わかりました:#16a34a;--警告:#f59e0b;--ええ:#ef4444; } *{ボックスサイズ:ボーダーボックス} body{margin:0;背景:var(--bg);色:var(--ink);font-family:system-ui,-apple-system,"Segoe UI","平木野角ゴシック ProN","能登Sans JP",サンセリフ} header{position:sticky;トップ:0;Zインデックス:50;背景:rgba(255,255,255,.9);背景フィルター:彩度(180%)ぼかし(8px);border-bottom:1px solid var(--bd)} .bar{最大幅:1100px;margin:auto;display:flex;ギャップ:12px;align-items:center;パディング:10px 16px} .brand{フォントの太さ:800} .pill{パディング:.5rem .9rem;border:1px solid var(--bd);ボーダー半径:999px;背景:#fff} メイン{最大幅:1100px;マージン:16px 自動;パディング:0 16px} section{background:var(--カード);border:1px solid var(--bd);ボーダー半径:16px;パディング:16px;余白:16px 0} h2{マージン:.2rem 0 1rem} .row{ディスプレイ:フレックス;ギャップ:12px;フレックスラップ:ラップ} .col{フレックス:1 1 320px} textarea,select,input[type="text"]{width:100%;パディング:12px 14px;border:1px solid var(--bd);ボーダー半径:12px;フォントサイズ:16px;背景:#fff} ボタン{カーソル:ポインタ} .btn{パディング:14px 18px;ボーダー半径:14px;border:1px solid var(--bd);背景:#fff;フォントの太さ:700;フォントサイズ:16px;ボックスシャドウ:0 6px 18px rgba(0,0,0,.06)} .btn.pri{背景:var(--pri);カラー:#fff;ボーダーカラー:透明} .btn.ok{背景:var(--ok);カラー:#fff;ボーダーカラー:透明} .btn.warn{背景:var(--warn);カラー:#fff;ボーダーカラー:透明} .grid3{表示:グリッド;グリッドテンプレート列:repeat(3,minmax(0,1fr));ギャップ:10px} .chips{ディスプレイ:フレックス;flex-wrap:ラップ;ギャップ:8px} .chip{パディング:10px 12px;border:1px solid var(--bd);ボーダー半径:999px;背景:#fff;フォントサイズ:14px} .kv{display:flex;ギャップ:12px;項目の整列:center} .kv ラベル{最小幅:6em;色:var(--sub)} .muted{色:var(--sub);フォントサイズ:13px} /* === プリホーム &; 各ボットホーム(被せUI) === */ .cb-layer{位置:固定;挿入図:0;display:flex;align-items:center;justify-content:center; 背景:rgba(255,255,255,.95);Zインデックス:9999;パディング:24px} .cb-wrap{幅:最小(720px,92vw)} .cb-title{フォントサイズ:1.6rem;マージン:0 0 12px;フォントの太さ:700} .cb-grid{表示:グリッド;ギャップ:14px} .cb-card,.cb-big{高さ:88px;フォントサイズ:1.4rem;フォントの太さ:700;ボーダー半径:16px;border:1px solid var(--bd); ボックスシャドウ:0 6px 18px rgba(0,0,0,.08);背景:#fff;カーソル:ポインタ} .cb-card{ディスプレイ:フレックス;align-items:center;内容を揃えて:センター} .cb-fab{位置:固定;右:18px;下:18px;幅:56px;高さ:56px;ボーダー半径:999px; フォントサイズ:24px;border:なし;ボックスシャドウ:0 6px 18px rgba(0,0,0,.18);背景:#fff;Zインデックス:9998;カーソル:ポインタ} @media (hover:hover){.cb-card:hover,.cb-big:hover{transform:translateY(-1px);}} </スタイル> </頭> <本体> <ヘッダー> <div class="bar"> <div class="brand">CareBot v2</div> <div class="pill">言語:<span id="langState">JA ⇄ EN/VI/TL</span></div> <div class="pill">音量 <input id="volRange" type="range" min="0" max="1" step="0.01" style="vertical-align:middle"></div> <div class="pill">速度 <input id="rateRange" type="range" min="0.6" max="1.4" step="0.05" value="1.0" style="vertical-align:middle"></div> </div> </ヘッダー> <メイン> <!-- ====== 話す（マイク） ====== --> <セクション id="パネルトーク"> <h2> 🎙️ 話す</h2> <div class="row"> <div class="col"> <p class="muted">ボットに向かって話しかけてください。「ゆっくり話して」「ありがとう」などは確定応答します。</p> <ボタン id="micBtn" class="btn pri" style="width:220px;高さ:64px;font-size:20px"> 🎙️ マイク開始</button> <div style="margin-top:10px" class="chips"> <button class="chip" data-quick="ありがとうございます">ありがとうございます</button> <button class="chip" data-quick="ゆっくり話してください">ゆっくり話してください</button> <button class="chip" data-quick="この近くのおすすめは?">この近くのおすすめは?</button> </div> </div> <div class="col"> <div><strong>直近の応答</strong></div> <div id="lastReply" class="pill" style="min-height:56px"></div> </div> </div> </セクション> <!-- ====== 翻訳 ====== --> <セクション id="panel-translate"> <h2> 🌐 翻訳</h2> <div class="row"> <div class="col"> <div class="kv"> <label>入力言語</label> <select id="srcLang"> <option value="ja">日本語</option> <option value="en">英語</option> <option value="vi">Tiếng Việt</option> <option value="tl">タガログ語</option> </選択> </div> <div class="kv"> <label>出力言語</label> <select id="dstLang"> <option value="en">英語</option> <option value="vi">Tiếng Việt</option> <option value="tl">タガログ語</option> <option value="ja">日本語</option> </選択> </div> <textarea id="translateInput" rows="5" placeholder="ここに文章を入力"></textarea> <div class="row"> <button id="btnTranslate" class="btn pri">翻訳して読み上げ</button> <button id="btnClearT" class="btn">クリア</button> </div> </div> <div class="col"> <div><strong>翻訳結果(B原文 / 日本語訳)</strong></div> <div id="translateOutA" class="pill" style="min-height:52px;margin-bottom:10px"></div> <div id="translateOutB" class="pill" style="min-height:52px"></div> </div> </div> </セクション> <!-- ====== 観光案内 ====== --> <section id="panel-tour"> <h2> 🧭 観光案内</h2> <p class="muted">鳴子温泉・古川エリアのFAQを中心に、多言語で案内します。</p> <div class="chips" style="margin-bottom:10px"> <button class="chip" data-ask="鳴子温泉で家族風呂はありますか?">家族風呂</button> <button class="chip" data-ask="鳴子温泉駅から鬼首間欠泉へ公共交通で行きたい">鬼首間欠泉への行き方</button> <button class="chip" data-ask="休日・夜間の救急対応は?">休日夜間の医療</button> </div> <div class="row"> <div class="col"> <textarea id="tourInput" rows="4" placeholder="知りたいことを入力(例:この近くで車いすで入れるお店は?)"></textarea> <div class="row"> <button id="btnAskTour" class="btn pri">聞く</button> <button id="btnClearTour" class="btn">クリア</button> </div> </div> <div class="col"> <div><strong>回答</strong></div> <div id="tourAnswer" class="pill" style="min-height:120px"></div> <div style="margin-top:8px" class="muted">※ 方向の定型文(「まっすぐ.../Go straight」等)はサーバ側で禁止・確認質問へ置換します。</div> </div> </div> </セクション> <!-- ====== 安否確認（介護） ====== --> <section id="パネルチェックイン"><h2> ✅ 安否確認</h2><p class="muted">毎日所定の時間に起動し、「元気ですか?」などを確認→家族・職員へ通知します。</p><div class="row"><div class="col"><div class="kv"><label>朝の確認</label><input id="amTime" type="time" value="09:00" /></div><div class="kv"><label>夕の確認</label><input id="pmTime" type="time" value="19:00" /></div><button id="btnSaveCheckin" class="btn ok">保存</button></div><div class="col"><div><strong>最近の結果</strong></div><div id="checkinLog" class="pill" style="min-height:56px"></div></div></div></セクション><!-- ====== 設定 ====== --> <セクション ID="パネル設定"><h2>⚙️設定</h2><div クラス="行"><div クラス="col"><div クラス="kv"><label>通知メール</label><input type="text" id="notifyEmail" placeholder="family@example.com"></div><div class="kv"><label>通知LINE</label><input type="text" id="notifyLine" placeholder="@line_id"></div><ボタン id="btnSaveSettings" class="btn ok">保存</button></div><div class="col"><div><strong>状態</strong></div><div id="health" class="pill">TTS: 未確認 / API: 未確認</div></div></div></セクション></メイン> <!-- ===== プリホーム：どちらのボット？ ===== --> <div id="cb-prehome" class="cb-layer" 非表示><div class="cb-wrap"><h1 class="cb-title">どちらを使いますか?</h1><div class="cb-grid"><button class="cb-card" data-bot="care"> 🤝 介護支援ボット</button><button class="cb-card" data-bot="tour"> 🧭 翻訳学習/観光案内ボット</button></div></div></div> <!-- ===== ホーム（ボット別の3ボタン） ===== --><div id="cb-home" class="cb-layer" 非表示の aria-label="ホームメニュー"><div class="cb-wrap"><h1 id="cb-home-title" class="cb-title"></h1><div id="cb-home-buttons" class="cb-grid"></div></div></div><ボタン id="cb-home-fab" class="cb-fab" title="ホームへ/ボット切替">🏠</button> <!-- 既存のロジック --> <script src="chatbot.v3.js" defer></script><!-- 画面制御（プリホーム＋3ボタン／既存機能ブリッジ） --> <スクリプト> (()=> { const $ = s=>document.querySelector(s); ===== 音量・速度(画面からの調整 → 既存JSへ連携) =====const vol = $('#volRange'), rate = $('#rateRange');vol?です。addEventListener('input', ()=> window.dispatchEvent(new CustomEvent('carebot:set-volume',{detail:{volume:parseFloat(vol.value)}}))); 率。。addEventListener('input',()=> window.dispatchEvent(new CustomEvent('carebot:set-rate',{detail:{rate:parseFloat(rate.value)}}))); // ===== クイックチップ（話す） ===== document.querySelectorAll('[データクイック]').forEach(el=>{el.addEventListener('クリック', ()=> {const text = el.getAttribute('データクイック');window.dispatchEvent(new CustomEvent('carebot:quick-say',{detail:{text}})); }); }); ===== 翻訳(UI → 既存JSの translateAndSpeak があれば使用、なければ簡易フォールバック) =====非同期関数 simpleTranslateSpeak(){定数テキスト = $('#translateInput').value.trim();定数 src = $('#srcLang').value;定数 dst = $('#dstLang').value;if(!text) 戻る;試す{ // 既存の関数があれば使う if (window.translateAndSpeak === '関数'){const out = window.translateAndSpeak({text, src, dst})を待つ;$('#translateOutA').textContent = out?です。 翻訳元。。 ''; $('#translateOutB').textContent = out?です。翻訳先。。''; 帰る; } フォールバック(/ja/translate → /tts 再生は chatbot.v3.js 側で) const r = await fetch('/ja/translate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text, src_lang:src, target_lang:dst})}); const tx = 待機 r.text(); $('#translateOutA').textContent = (dst==='ja'? tx : tx);// 表示はそのまま $('#translateOutB').textContent = '';// 同期訳は任意 window.dispatchEvent(new CustomEvent('carebot:play-tts',{detail:{text:tx, lang:dst}})); }catch(e){ alert('翻訳に失敗しました'); console.error(e); } } $('#btnTranslate')?です。addEventListener('クリック', simpleTranslateSpeak); $('#btnClearT')?です。addEventListener('クリック', ()=>{ $('#translateInput').value=''; $('#translateOutA').textContent=''; $('#translateOutB').textContent=''; }); 観光:UIから /ja/suggest を呼ぶのは既存JSに任せる(イベントだけ送る) $('#btnAskTour')?.addEventListener('クリック', ()=>{ const text = $('#tourInput').value.trim();if(!text) return; window.dispatchEvent(new CustomEvent('carebot:ask-tour',{detail:{text}})); }); $('#btnClearTour')?.addEventListener('クリック', ()=>{ $('#tourInput').value=''; $('#tourAnswer').textContent=''; }); document.querySelectorAll('[data-ask]')?です。forEach(el=>{ el.addEventListener('click', ()=>{ $('#tourInput').value = el.getAttribute('data-ask'); $('#btnAskTour').click(); }); }); // ===== プリホーム／各ボットホーム ===== const pre = $('#cb-prehome'), home=$('#cb-home'), fab=$('#cb-home-fab'); const title=$('#cb-home-title'), box=$('#cb-home-buttons'); function show(el){ el.hidden=false; }関数 hide(el){ el.hidden=true; } 関数 hideAll(){ hide(pre); hide(home); } 既存UIへの橋渡し(必要ならセレクタをあなたのDOMに合わせて変更) 関数 goTalk(){ const el = $('#micBtn,[data-action="mic"],button[aria-label*="マイク"]'); if (el) el.click();else window.dispatchEvent(new CustomEvent('carebot:start-mic')); } 関数 goTranslate(){ ($('#nav-translate,a[href*="translate"]')||{}).click?をクリックします。(); $('#panel-translate,.translate-panel')?です。scrollIntoView({動作:'スムーズ',ブロック:'開始'}); $('#translateInput, textarea[name="translate"]')?.焦点。。(); window.dispatchEvent(new CustomEvent('carebot:open-translate')); } 関数 goGuide(){ ($('#nav-tour,a[href*="tour"],a[href*="guide"]')||{}).click?をクリックします。(); $('#panel-tour,.tour-panel,.guide-panel')?です。scrollIntoView({動作:'スムーズ',ブロック:'開始'}); window.dispatchEvent(new CustomEvent('carebot:open-tour')); } 関数 goCheckin(){ ($('#nav-checkin,[data-panel="checkin"]')||{}).click?をクリックします。(); $('#panel-checkin,.checkin-panel')?です。scrollIntoView({動作:'スムーズ',ブロック:'開始'}); window.dispatchEvent(new CustomEvent('carebot:open-checkin')); } 関数 goSettings(){ ($('#nav-settings,[data-panel="settings"]')||{}).click?をクリックします。(); $('#panel-settings,.settings-panel')?です。scrollIntoView({動作:'スムーズ',ブロック:'開始'}); window.dispatchEvent(新しいCustomEvent('carebot:open-settings')); } 定数ホーム = { care: { title:'介護支援ボット', buttons:[ {label:' 🎙️ 話す',action:goTalk}, {label:' ✅ 安否確認',action:goCheckin}, {label:' ⚙️ 設定',action:goSettings} ]}, tour: { title:'翻訳学習/観光案内ボット', buttons:[ {label:' 🎙️ 話す',action:goTalk}, {label:' 🌐 翻訳',action:goTranslate}, {label:' 🧭 観光案内',action:goGuide} ]}, }; 関数 renderHome(kind){ title.textContent = HOMES[種類].title;box.innerHTML=''; HOMES[種類].buttons.forEach(b=>{ const btn=document.createElement('ボタン');btn.className='cb-big';btn.textContent=b.ラベル; btn.onclick=()=>{ hideAll(); b.action(); }; box.appendChild(btn); }); } 定数保存済み = localStorage.getItem('cb-bot');「ケア」または「ツアー」 if (!saved){ show(pre); } else { renderHome(saved); show(home); } pre.querySelectorAll('[データボット]').forEach(btn=>{ btn.addEventListener('クリック', ()=>{ const kind = btn.getAttribute('データボット'); localStorage.setItem('cb-bot', 種類); renderHome(種類);hide(プレ);show(ホーム); }); }); fab.addEventListener('クリック', ()=>{ const k = localStorage.getItem('cb-bot') ||'ツアー'; レンダーホーム(k);show(ホーム); }); fab.addEventListener('contextmenu', (e)=>{ e.preventDefault(); show(pre); hide(home); }); ===== 既存JSからのイベントをUIに反映(任意) ===== window.addEventListener('carebot:set-last-reply', (e)=>{ $('#lastReply').textContent = e.detail?.テキスト。。'';}); window.addEventListener('carebot:set-tour-answer', (e)=>{ $('#tourAnswer').textContent = e.detail?.テキスト。。'';}); // マイクボタンのフォールバック：存在する関数を順に探す $('#micBtn')?.addEventListener('クリック', ()=>{ if (window.startMic) return window.startMic(); if (window.チャットボット?startMic)の戻りウィンドウ。ChatBot.startMic(); window.dispatchEvent(new CustomEvent('carebot:start-mic')); }); // 簡易ヘルスチェック（任意） (非同期 ()=>{ try{ const r = 待機フェッチ('/__health');あればOK const ok = r.ok ?'OK' : 'NG'; $('#health').textContent = 'TTS: 未確認 / API: ${ok}'; }catch{ /* 無視 */ } })(); })(); </script> </ボディ> </html> ``` 私の意見： - まずは**このまま置き換え**→動かし、反応しない箇所があれば **セレクタ(例:'#micBtn', '#panel-translate')を1–2か所だけ**あなたのDOMに合わせて調整すればOKです。 - 右下🏠クリック＝ホーム表示、**右クリック＝ボット切替**。 - 既存の 'chatbot.v3.js' があれば、自動で橋渡しします(無ければフォールバックも入れています)。 ::contentReference[oaicite:0]{index=0}<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AIみまくん＋インボイスデモ</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    .chat-title{ text-align:center; margin:1rem 0; }
    #chat-window{ border:1px solid #ddd; border-radius:8px; min-height:180px; padding:8px; margin:8px 0; }
    .input-panel{ display:grid; grid-template-columns:1fr auto auto; gap:8px; align-items:center; }
    .role-label{ grid-column:1 / -1; font-weight:bold; margin-top:8px; }
    .template-start{ margin:0.5rem auto; display:inline-block; }
    #template-buttons{ display:flex; flex-wrap:wrap; gap:6px; justify-content:center; margin-bottom:8px; }
    .action-buttons{ display:flex; gap:8px; justify-content:center; margin-top:12px; }
  </style>
</head>
<body>
  <header>
    <nav style="display:flex; justify-content:center; gap:1rem; margin:1rem 0;">
      <a href="https://robostudy.jp/test/index.html" class="btn btn-outline-primary">🔙 戻る</a>
      <a href="/camera-test/" class="btn btn-outline-secondary" target="_blank" rel="noopener">カメラテスト</a>
      <a href="/daily_report" class="btn btn-outline-secondary" target="_blank" rel="noopener">見守りレポート</a>
<a class="btn btn-outline-secondary" href="/translate">翻訳学習／観光案内</a>
<a class="btn btn-outline-secondary" href="/assist">介護＋翻訳のハブ</a>
    </nav>
  </header>
<button id="enable-audio" style="position:fixed;inset:auto 12px 12px auto;z-index:9999;padding:10px 14px;border-radius:12px;">
  🔊 タップで音を有効化
</button>
<script>
(() => {
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let audioCtx = null;
  let unlocked = false;

  async function unlockAudio() {
    if (unlocked) return true;
    if (!audioCtx) audioCtx = new AudioCtx();
    try {
      await audioCtx.resume();
      unlocked = (audioCtx.state === 'running');
      if (unlocked) document.getElementById('enable-audio')?.remove();
      return unlocked;
    } catch (e) { return false; }
  }

  // 初回タップ/クリックで解放
  const btn = document.getElementById('enable-audio');
  ['pointerdown','touchstart','click'].forEach(ev => {
    window.addEventListener(ev, unlockAudio, { once:true, passive:true });
    btn?.addEventListener(ev, unlockAudio, { once:true, passive:true });
  });

  // 音声再生の共通関数（mp3 URLを渡す）
  window.playTTS = async function(audioUrl) {
    await unlockAudio();
    const a = new Audio();
    a.playsInline = true;  // iOSで全画面化を防ぐ
    a.preload = 'auto';
    a.crossOrigin = 'anonymous';
    // キャッシュで無音化するケース対策にダミークエリ付与
    a.src = audioUrl + (audioUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
    try {
      await a.play();
    } catch (err) {
      // 失敗時はボタンを再表示して再タップを促す
      if (!document.getElementById('enable-audio')) {
        const b = document.createElement('button');
        b.id = 'enable-audio';
        b.textContent = '🔊 もう一度タップで音を有効化';
        b.style = 'position:fixed;inset:auto 12px 12px auto;z-index:9999;padding:10px 14px;border-radius:12px;';
        b.addEventListener('click', unlockAudio, { once:true });
        document.body.appendChild(b);
      }
      console.error('play failed:', err);
    }
  }
})();
</script>

  <main>
    <h2 class="chat-title">介護支援ボット</h2>

    <!-- ★ 旧JS互換：button→a に変更（IDはそのまま） -->
    <div style="margin: 1rem 0; text-align: center;">
      <a href="#" id="template-start-btn" class="template-start btn">テンプレート対話開始</a>
      <div id="template-buttons"></div>
　　　
    </div>

    <div id="chat-window"></div>

    <div class="input-panel">
      <label class="role-label caregiver" for="caregiver-input">介護士</label>
      <input id="caregiver-input" type="text" placeholder="介護士の発言を入力" />
      <button id="mic-caregiver" type="button">🎤</button>
      <button id="send-caregiver" type="button">送信</button>

      <label class="role-label caree" for="caree-input">被介護者</label>
      <input id="caree-input" type="text" placeholder="被介護者の発言を入力" />
      <button id="mic-caree" type="button">🎤</button>
      <button id="send-caree" type="button">送信</button>
    </div>

    <section id="glossary" style="margin-top:16px;">
      <input type="text" id="term" placeholder="用語を入力" />
      <button id="explain-btn" type="button">説明</button>
      <p id="explanation"></p>
    </section>

    <!-- （バックアップ通り）翻訳パネルはそのまま残しています -->
    <section id="translation-panel">
      <select id="translate-direction">
        <option value="ja-en" selected>日本語→英語</option>
        <option value="en-ja">英語→日本語</option>
        <option value="ja-vi">日本語→ベトナム語</option>
        <option value="vi-ja">ベトナム語→日本語</option>
        <option value="ja-tl">日本語→タガログ語</option>
        <option value="tl-ja">タガログ語→日本語</option>
      </select>
      <button id="translate-btn" type="button">翻訳して読み上げ</button>
      <p id="translation-result"></p>
    </section>

<!-- 🤝 往復会話モード UI -->
<div id="conv-controls" style="margin:8px 0; display:flex; gap:12px; flex-wrap:wrap;">
  <label>🤝 会話モード <input id="convMode" type="checkbox"></label>
  <label>Aの言語:
    <select id="langA">
      <option value="ja-JP" selected>日本語</option>
      <option value="en-US">英語</option>
      <option value="vi-VN">ベトナム語</option>
      <option value="fil-PH">タガログ語</option>
    </select>
  </label>
  <label>Bの言語:
    <select id="langB">
      <option value="en-US" selected>英語</option>
      <option value="ja-JP">日本語</option>
      <option value="vi-VN">ベトナム語</option>
      <option value="fil-PH">タガログ語</option>
    </select>
  </label>
  <label>🤖 返答案をAIで作る <input id="autoSuggest" type="checkbox" checked></label>
</div>

<!-- クイック返答ボタン置き場 -->
<div id="quick-replies" style="display:flex; gap:8px; flex-wrap:wrap; margin:6px 0;"></div>

    <div class="action-buttons">
      <button id="save-log-btn" type="button">会話ログ保存</button>
      <a class="btn" href="/daily_report" target="_blank" rel="noopener">📝 日報を生成</a>
    </div>
  </main>

  <!-- ★ キャッシュ破り：クエリ付きで必ず最新JSを取得 -->
  <script defer src="/static/js/chatbot.v3.js?v=20250904k"></script>

</body>
</html>
