<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>翻訳学習／観光案内</title>
  <!-- キャッシュバスター付き 共通CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=tx-ui-20250902">
  <!-- ここからページ専用CSS（※必ず <style>〜</style> で囲む） -->
  <style>
    :root{
      --brand-blue:#1a73e8;
      --brand-green:#28a745;
      --chip:#f3f6f9; --bd:#e5e7eb; --text:#111827;
    }
    body{color:var(--text);}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    nav{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px}
    .link{color:var(--brand-blue);text-decoration:none;border-bottom:1px solid transparent}
    .link:hover{border-color:var(--brand-blue)}
    .title{margin:8px 0 14px;text-align:center;color:var(--brand-blue);font-size:2rem;font-weight:800}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0}
    .btn{padding:.55rem .9rem;border:1px solid var(--bd);border-radius:10px;background:#fff;cursor:pointer}
    .btn:active{transform:scale(.98)}
    .btn-primary{background:var(--brand-green);border-color:var(--brand-green);color:#fff}
    .btn-primary:hover{filter:brightness(0.95)}
    .select, textarea{border:1px solid var(--bd);border-radius:10px;padding:.5rem .6rem}
    .select{height:40px}
    textarea{width:100%;min-height:110px}
    .templates{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
    .chip{background:var(--chip);border:1px solid var(--bd);border-radius:999px;padding:.4rem .7rem;cursor:pointer}
    .chip:hover{filter:brightness(0.98)}
    .out{font-size:1.6rem;line-height:1.7;border:1px solid var(--bd);border-radius:12px;padding:12px;min-height:3.2em;background:#fff}
    .hint{display:block;margin-top:6px;color:#6b7280}
    .hidden{display:none!important}
  </style>
</head>
<body>
  <div class="wrap">
    <nav>
      <a class="link" href="/">← 介護ボットへ戻る</a>
      <a class="link" href="/daily_report" target="_blank" rel="noopener">📝 見守りレポート</a>
      <a class="link" href="/assist">介護＋翻訳のハブ</a>
    </nav>

    <h1 class="title">翻訳学習／観光案内</h1>

    <div class="toolbar">
      <label>モード:
        <select id="tx-mode" class="select">
          <option value="lang" selected>翻訳学習</option>
          <option value="tour">観光案内</option>
        </select>
      </label>
      <label>翻訳方向:
        <select id="tx-dir" class="select">
          <option value="ja-en" selected>日本語→英語</option>
          <option value="en-ja">英語→日本語</option>
          <option value="ja-vi">日本語→ベトナム語</option>
          <option value="vi-ja">ベトナム語→日本語</option>
          <option value="ja-tl">日本語→タガログ語</option>
          <option value="tl-ja">タガログ語→日本語</option>
        </select>
      </label>
      <button id="tx-show-templates" class="btn">テンプレ表示</button>
      <button id="tx-translate" class="btn btn-primary">翻訳して表示</button>
      <button id="tx-mic" class="btn btn-primary">🎤 マイク</button>
      <span id="tx-mic-status" class="hint"></span>
      <input id="tx-file" type="file" accept="audio/*" capture class="hidden" />
    </div>

    <div id="tx-templates" class="templates"></div>

    <label for="tx-input" class="hint">話す内容</label>
    <textarea id="tx-input" placeholder="例：おはようございます。今日はどこへ行きますか？"></textarea>

    <h3 class="hint" style="margin-top:12px">訳文</h3>
    <div id="tx-out" class="out"></div>
    <audio id="tx-audio" controls playsinline class="hidden" style="margin-top:8px"></audio>
<!-- 🔊 音量スライダーを追加 -->
<label for="volumeRange" class="hint">🔊 音量調整:
  <input id="volumeRange" type="range" min="-10" max="10" step="1" value="6">
  <span id="volumeVal">6</span> dB
</label>
    <span id="tx-audio-hint" class="hint"></span>
  </div>

  <script>
  const TPL_LANG=["おはようございます（Good morning）","ありがとうございます（Thank you）","ゆっくり話してください（Please speak slowly）","もう一度お願いします（One more time, please）"];
  const TPL_TOUR=["駅はどちらですか？","この近くのおすすめは？","いくらですか？カードは使えますか？","助けてください。道に迷いました。"];
  const $=id=>document.getElementById(id);
  const elIn=$('tx-input'), elOut=$('tx-out'), elAu=$('tx-audio'), elHint=$('tx-audio-hint'), elMic=$('tx-mic'), elMicStatus=$('tx-mic-status'), elFile=$('tx-file');

  const ttsLangFrom=(p)=>{p=(p||'ja-en').toLowerCase(); if(p==='ja-en')return'en-US'; if(p==='en-ja')return'ja-JP'; if(p==='ja-vi')return'vi-VN'; if(p==='vi-ja')return'ja-JP'; if(p==='ja-tl')return'fil-PH'; if(p==='tl-ja')return'ja-JP'; return'ja-JP';};
  const srcLangFrom=(p)=>{p=(p||'ja-en').toLowerCase(); if(p==='ja-en'||p==='ja-vi'||p==='ja-tl')return'ja-JP'; if(p==='en-ja')return'en-US'; if(p==='vi-ja')return'vi-VN'; if(p==='tl-ja')return'fil-PH'; return'ja-JP';};

  async function translateAndSpeak(text, dir){
    if(!text) return;
    elOut.textContent='翻訳中…';
    try{
      const r=await fetch('/ja/translate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text, direction:dir})});
      if(!r.ok) throw new Error('translate '+r.status);
      const j=await r.json(); const t=(j.translated||'').trim();
      elOut.textContent=t||'（訳文なし）';

      if(t){
        let ok=false;
        try{
          const a=await fetch('/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:t, lang:ttsLangFrom(dir)})});
          if(a.ok){
            const b=await a.blob(); const url=URL.createObjectURL(b);
            elAu.src=url; elAu.classList.remove('hidden');
            if(elHint){ elHint.textContent=''; elHint.onclick=null; elHint.style.cursor=''; }
            try{ await elAu.play(); ok=true; }
            catch{ if(elHint){ elHint.innerHTML='▶️ タップで再生'; elHint.style.cursor='pointer'; elHint.onclick=async()=>{ try{ await elAu.play(); elHint.textContent=''; elHint.onclick=null; elHint.style.cursor=''; }catch{} }; } ok=true; }
          }
        }catch{}
        if(!ok && 'speechSynthesis' in window){
          try{
            const u=new SpeechSynthesisUtterance(t);
            u.lang=ttsLangFrom(dir);
            speechSynthesis.cancel(); speechSynthesis.speak(u);
            if(elHint) elHint.textContent='（端末音声で再生中）';
          }catch{ if(elHint) elHint.textContent='音声生成に失敗しました'; }
        }else if(!ok){
          if(elHint) elHint.textContent='音声生成に失敗しました';
        }
      }
    }catch(e){ console.error(e); elOut.textContent='翻訳エラーが発生しました。'; }
  }

  function renderTemplates(){
    const items=($('tx-mode').value==='tour')?TPL_TOUR:TPL_LANG;
    const box=$('tx-templates'); box.innerHTML='';
    items.forEach(s=>{
      const btn=document.createElement('button');
      btn.className='chip'; btn.textContent=s;
      btn.onclick=()=>{ elIn.value=s.replace(/（.*?）/,''); $('tx-translate').click(); };
      box.appendChild(btn);
    });
  }

  let rec=null; const hasSR=('webkitSpeechRecognition' in window);
  elMic.addEventListener('click',()=>{
    if(hasSR){
      if(rec){ rec.stop(); rec=null; elMicStatus.textContent=''; return; }
      const r=new webkitSpeechRecognition(); rec=r;
      r.lang=srcLangFrom($('tx-dir').value); r.interimResults=false; r.continuous=false;
      elMicStatus.textContent='🎙️ 聞き取り中…';
      r.onresult=(e)=>{ const s=Array.from(e.results).map(r=>r[0].transcript).join(' ').trim(); if(s){ elIn.value=s; $('tx-translate').click(); } };
      r.onend=()=>{ elMicStatus.textContent=''; rec=null; };
      r.onerror=()=>{ elMicStatus.textContent=''; rec=null; };
      r.start();
    }else{ elFile.click(); }
  });

  elFile.addEventListener('change',async()=>{
    const file=elFile.files&&elFile.files[0]; if(!file)return;
    elMicStatus.textContent='📤 アップロード中…';
    try{
      const fd=new FormData(); fd.append('audio',file);
      const res=await fetch('/stt',{method:'POST',body:fd}); const j=await res.json();
      const s=(j.text||'').trim(); if(s){ elIn.value=s; $('tx-translate').click(); }
    }catch{ elMicStatus.textContent='❌ 文字起こし失敗'; return; }
    elMicStatus.textContent=''; elFile.value='';
  });

  $('tx-show-templates').addEventListener('click', renderTemplates);
  $('tx-translate').addEventListener('click',()=>translateAndSpeak(elIn.value.trim(), $('tx-dir').value||'ja-en'));
  elIn.addEventListener('keydown',(e)=>{ if(e.key==='Enter'&&(e.ctrlKey||e.metaKey)){ e.preventDefault(); $('tx-translate').click(); } });
  // === 音量スライダー連動 ===
  const volRange = document.getElementById("volumeRange");
  const volVal = document.getElementById("volumeVal");
  if(volRange && volVal){
    volRange.addEventListener("input", () => {
      volVal.textContent = volRange.value;
    });
    // グローバルに公開 → chatbot.v3.js から参照可能
    window.getTTSVolume = () => parseFloat(volRange.value || "0");
  }

  </script>
</body>
</html>
