<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç¿»è¨³å­¦ç¿’ï¼è¦³å…‰æ¡ˆå†…</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=tx-ui-20250903">

  <style>
    :root{
      --brand-blue:#1a73e8; --brand-green:#28a745;
      --chip:#f3f6f9; --bd:#e5e7eb; --text:#111827;
      --a-bg:#e6f4ff; --a-bd:#b5daff; --b-bg:#fff2cc; --b-bd:#ffe28a;
    }
    body{color:var(--text);}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    nav{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px}
    .link{color:var(--brand-blue);text-decoration:none;border-bottom:1px solid transparent}
    .link:hover{border-color:var(--brand-blue)}
    .title{margin:8px 0 14px;text-align:center;color:var(--brand-blue);font-size:2rem;font-weight:800}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0}
    .btn{padding:.55rem .9rem;border:1px solid var(--bd);border-radius:10px;background:#fff;cursor:pointer}
    .btn:active{transform:scale(.98)}
    .btn-primary{background:var(--brand-green);border-color:var(--brand-green);color:#fff}
    .btn-primary:hover{filter:brightness(0.95)}
    .select, textarea{border:1px solid var(--bd);border-radius:10px;padding:.5rem .6rem}
    .select{height:40px}
    textarea{width:100%;min-height:110px}
    .templates{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
    .chip{background:var(--chip);border:1px solid var(--bd);border-radius:999px;padding:.4rem .7rem;cursor:pointer}
    .chip:hover{filter:brightness(0.98)}
    .out{font-size:1.6rem;line-height:1.7;border:1px solid var(--bd);border-radius:12px;padding:12px;min-height:3.2em;background:#fff}
    .hint{display:block;margin-top:6px;color:#6b7280}
    .hidden{display:none!important}
    #dialogue-log{margin-top:10px}
    #dialogue-log .msg{padding:8px 12px;border-radius:12px;margin:6px 0;max-width:90%}
    #dialogue-log .a{background:var(--a-bg);border:1px solid var(--a-bd)}
    #dialogue-log .b{background:var(--b-bg);border:1px solid var(--b-bd)}
    #dialogue-log .role{font-size:12px;opacity:.7;display:block;margin-bottom:2px}
  </style>
</head>
<body>
  <div class="wrap">
    <nav>
      <a class="link" href="/">â† ä»‹è­·ãƒœãƒƒãƒˆã¸æˆ»ã‚‹</a>
      <a class="link" href="/daily_report" target="_blank" rel="noopener">ğŸ“ è¦‹å®ˆã‚Šãƒ¬ãƒãƒ¼ãƒˆ</a>
      <a class="link" href="/assist">ä»‹è­·ï¼‹ç¿»è¨³ã®ãƒãƒ–</a>
    </nav>

    <h1 class="title">ç¿»è¨³å­¦ç¿’ï¼è¦³å…‰æ¡ˆå†…</h1>

    <div class="toolbar">
      <label>ãƒ¢ãƒ¼ãƒ‰:
        <select id="tx-mode" class="select">
          <option value="lang" selected>ç¿»è¨³å­¦ç¿’</option>
          <option value="tour">è¦³å…‰æ¡ˆå†…</option>
        </select>
      </label>
      <label>ç¿»è¨³æ–¹å‘:
        <select id="tx-dir" class="select">
          <option value="ja-en" selected>æ—¥æœ¬èªâ†’è‹±èª</option>
          <option value="en-ja">è‹±èªâ†’æ—¥æœ¬èª</option>
          <option value="ja-vi">æ—¥æœ¬èªâ†’ãƒ™ãƒˆãƒŠãƒ èª</option>
          <option value="vi-ja">ãƒ™ãƒˆãƒŠãƒ èªâ†’æ—¥æœ¬èª</option>
          <option value="ja-tl">æ—¥æœ¬èªâ†’ã‚¿ã‚¬ãƒ­ã‚°èª</option>
          <option value="tl-ja">ã‚¿ã‚¬ãƒ­ã‚°èªâ†’æ—¥æœ¬èª</option>
        </select>
      </label>
      <button id="tx-show-templates" class="btn">ãƒ†ãƒ³ãƒ—ãƒ¬è¡¨ç¤º</button>
      <button id="tx-translate" class="btn btn-primary">ç¿»è¨³ã—ã¦è¡¨ç¤º</button>
      <button id="tx-mic" class="btn btn-primary">ğŸ¤ ãƒã‚¤ã‚¯</button>
      <span id="tx-mic-status" class="hint"></span>
      <input id="tx-file" type="file" accept="audio/*" capture class="hidden" />
    </div>

    <div id="tx-templates" class="templates"></div>

    <label for="tx-input" class="hint">è©±ã™å†…å®¹</label>
    <textarea id="tx-input" placeholder="ä¾‹ï¼šãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€‚ä»Šæ—¥ã¯ã©ã“ã¸è¡Œãã¾ã™ã‹ï¼Ÿ"></textarea>

    <!-- ã‚¿ãƒ¼ãƒ³æ“ä½œ -->
    <div id="turn-buttons" style="display:flex; gap:8px; margin:8px 0;">
      <button id="send-as-a" class="btn">Aã¨ã—ã¦é€ä¿¡</button>
      <button id="send-as-b" class="btn" style="display:none;">Bã¨ã—ã¦é€ä¿¡</button>
    </div>
    <span id="turn-indicator" class="hint">æ¬¡ã¯ A ã•ã‚“ã®ç•ªã§ã™</span>

    <!-- ğŸ¤– Bç”¨ï¼šAIè¿”ç­” & ã‚¯ã‚¤ãƒƒã‚¯è¿”ç­” -->
    <div id="ai-controls" class="toolbar" style="gap:12px; margin-top:8px;">
      <button id="ai-reply" class="btn btn-primary">ğŸ¤– AIã§è¿”ç­”ï¼ˆBï¼‰</button>
      <label class="hint"><input type="checkbox" id="ai-auto"> Bã¯è‡ªå‹•ã§AIè¿”ç­”</label>
    </div>
    <div id="quick-replies" class="templates"></div>

    <!-- ä¼šè©±ãƒ­ã‚° -->
    <div id="dialogue-log"></div>

    <h3 class="hint" style="margin-top:12px">è¨³æ–‡</h3>
    <div id="tx-out" class="out"></div>
    <audio id="tx-audio" controls playsinline class="hidden" style="margin-top:8px"></audio>

    <!-- ğŸ”Š éŸ³é‡ -->
    <label for="volumeRange" class="hint">ğŸ”Š éŸ³é‡èª¿æ•´:
      <input id="volumeRange" type="range" min="-10" max="10" step="1" value="6">
      <span id="volumeVal">6</span> dB
    </label>
    <span id="tx-audio-hint" class="hint"></span>
  </div>

  <!-- å¾€å¾©ãƒ­ã‚¸ãƒƒã‚¯ -->
  <script>
  const TPL_LANG=["ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼ˆGood morningï¼‰","ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ˆThank youï¼‰","ã‚†ã£ãã‚Šè©±ã—ã¦ãã ã•ã„ï¼ˆPlease speak slowlyï¼‰","ã‚‚ã†ä¸€åº¦ãŠé¡˜ã„ã—ã¾ã™ï¼ˆOne more time, pleaseï¼‰"];
  const TPL_TOUR=["é§…ã¯ã©ã¡ã‚‰ã§ã™ã‹ï¼Ÿ","ã“ã®è¿‘ãã®ãŠã™ã™ã‚ã¯ï¼Ÿ","ã„ãã‚‰ã§ã™ã‹ï¼Ÿã‚«ãƒ¼ãƒ‰ã¯ä½¿ãˆã¾ã™ã‹ï¼Ÿ","åŠ©ã‘ã¦ãã ã•ã„ã€‚é“ã«è¿·ã„ã¾ã—ãŸã€‚"];
  const $=id=>document.getElementById(id);
  const elOut=$('tx-out'), elAu=$('tx-audio'), elMicStatus=$('tx-mic-status');

  // dir -> TTSè¨€èª
  const ttsLangFrom=(p)=>{p=(p||'ja-en').toLowerCase(); if(p==='ja-en')return'en-US'; if(p==='en-ja')return'ja-JP'; if(p==='ja-vi')return'vi-VN'; if(p==='vi-ja')return'ja-JP'; if(p==='ja-tl')return'fil-PH'; if(p==='tl-ja')return'ja-JP'; return'ja-JP';};
  const srcLangFrom=(p)=>{p=(p||'ja-en').toLowerCase(); if(p==='ja-en'||p==='ja-vi'||p==='ja-tl')return'ja-JP'; if(p==='en-ja')return'en-US'; if(p==='vi-ja')return'vi-VN'; if(p==='tl-ja')return'fil-PH'; return'ja-JP';};
  const reverseDir=(p)=>({ 'ja-en':'en-ja','en-ja':'ja-en','ja-vi':'vi-ja','vi-ja':'ja-vi','ja-tl':'tl-ja','tl-ja':'ja-tl'})[(p||'ja-en').toLowerCase()]||'en-ja';

  // çŠ¶æ…‹/UI
  let currentSpeaker='A';
  const elSendA=$('send-as-a'), elSendB=$('send-as-b'), elLog=$('dialogue-log'), elTurn=$('turn-indicator');
  const elQR=$('quick-replies'), elAiBtn=$('ai-reply'), elAiAuto=$('ai-auto');

  function updateTurnUI(){
    if(currentSpeaker==='A'){ elSendA.style.display=''; elSendB.style.display='none'; }
    else{ elSendA.style.display='none'; elSendB.style.display=''; }
    if(elTurn) elTurn.textContent = `æ¬¡ã¯ ${currentSpeaker==='A'?'A':'B'} ã•ã‚“ã®ç•ªã§ã™`;
  }

  // AA/BB è¡¨ç¤ºï¼ˆkind=åŸæ–‡/è¨³ï¼‰
  function logMessage(speaker, text, kind){
    const div=document.createElement('div');
    div.className='msg '+(speaker==='A'?'a':'b');
    const role=document.createElement('span'); role.className='role';
    role.textContent = speaker + (kind ? `ï¼ˆ${kind}ï¼‰` : '');
    const body=document.createElement('div'); body.textContent=text;
    div.appendChild(role); div.appendChild(body);
    elLog.appendChild(div);
    elLog.scrollTop=elLog.scrollHeight;
  }

  // ã‚¯ã‚¤ãƒƒã‚¯è¿”ç­”ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  function fallbackQS(forSpeaker, dir){
    const m={
      'ja-en':{A:["é§…ã¯ã©ã¡ã‚‰ã§ã™ã‹ï¼Ÿ","ã“ã®è¿‘ãã®ãŠã™ã™ã‚ã¯ï¼Ÿ","åŠ©ã‘ã¦ãã ã•ã„ã€‚é“ã«è¿·ã„ã¾ã—ãŸã€‚"],
               B:["Please go straight.","It is nearby.","There is a good restaurant."]},
      'en-ja':{A:["Where is the station?","Any recommendations?","Could you help me?"],
               B:["ã¾ã£ã™ãè¡Œã£ã¦ãã ã•ã„ã€‚","ã“ã®è¿‘ãã§ã™ã€‚","ãŠã™ã™ã‚ã®åº—ãŒã‚ã‚Šã¾ã™ã€‚"]},
      'ja-vi':{A:["ã©ã“ã«è¡Œã‘ã°ã„ã„ã§ã™ã‹ï¼Ÿ","ãŠã™ã™ã‚ã¯ï¼Ÿ","å†™çœŸã‚’æ’®ã£ã¦ãã ã•ã„ã€‚"],
               B:["Äi tháº³ng.","á» gáº§n Ä‘Ã¢y.","CÃ³ quÃ¡n Äƒn ngon."]},
      'vi-ja':{A:["TÃ´i nÃªn Ä‘i Ä‘Ã¢u?","Báº¡n gá»£i Ã½ gÃ¬?","LÃ m Æ¡n chá»¥p áº£nh giÃºp tÃ´i."],
               B:["ã¾ã£ã™ãé€²ã‚“ã§ãã ã•ã„ã€‚","ã“ã®è¿‘ãã§ã™ã€‚","ãŠã„ã—ã„åº—ãŒã‚ã‚Šã¾ã™ã€‚"]},
      'ja-tl':{A:["ãƒˆã‚¤ãƒ¬ã¯ã©ã“ï¼Ÿ","ãŠã™ã™ã‚ã¯ï¼Ÿ","é“ã«è¿·ã„ã¾ã—ãŸã€‚"],
               B:["Dumiretso po.","Malapit lang po.","May masarap na kainan."]},
      'tl-ja':{A:["Saan ang CR?","May mairerekomenda ka ba?","Naliligaw ako."],
               B:["ã¾ã£ã™ãè¡Œã£ã¦ãã ã•ã„ã€‚","ã“ã®è¿‘ãã§ã™ã€‚","ãŠã™ã™ã‚ã®åº—ãŒã‚ã‚Šã¾ã™ã€‚"]}
    };
    const key=(dir||'ja-en').toLowerCase();
    return (m[key]&&m[key][forSpeaker])?m[key][forSpeaker].slice(0,3):["ã¯ã„ã€ã‚ã‹ã‚Šã¾ã—ãŸã€‚","ã‚‚ã†å°‘ã—è©³ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚","ãŠã™ã™ã‚ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ"];
  }

  async function fetchSuggestions(forSpeaker){
    // ç›´è¿‘æ–‡è„ˆï¼ˆrole=A/B, text=åŸæ–‡/è¨³ã¯ä¸è¦ï¼‰
    const nodes=[...elLog.querySelectorAll('.msg')].slice(-8);
    const dialogue=nodes.map(n=>{
      const role=n.querySelector('.role')?.textContent||''; // "Aï¼ˆè¨³ï¼‰" ãªã©
      const speaker=role.startsWith('B')?'B':'A';
      const text=n.lastChild?.textContent||'';
      return {speaker,text};
    });
    const target=(forSpeaker==='A')?srcLangFrom(reverseDir(document.getElementById('tx-dir').value||'ja-en')):srcLangFrom(document.getElementById('tx-dir').value||'ja-en');

    try{
      const r=await fetch('/ja/suggest',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({dialogue, target_lang:target, role:forSpeaker, n:3})});
      const j=await r.json();
      const arr=j && (j.suggestions||j.candidates);
      if(Array.isArray(arr) && arr.length) return arr.slice(0,3);
    }catch(_e){}
    return fallbackQS(forSpeaker, document.getElementById('tx-dir').value||'ja-en');
  }

  async function renderQuickReplies(forSpeaker){
    elQR.innerHTML='';
    const arr=await fetchSuggestions(forSpeaker);
    arr.forEach(s=>{
      const b=document.createElement('button');
      b.className='chip'; b.textContent=s;
      b.onclick=()=>addTurnAndSpeakLocal(forSpeaker, s);
      elQR.appendChild(b);
    });
  }

  async function aiReplyB(){
    const cand=await fetchSuggestions('B');
    const text=cand[0]||'Okay.';
    await addTurnAndSpeakLocal('B', text);
  }

  async function addTurnAndSpeakLocal(speaker, text){
    const dirSel=document.getElementById('tx-dir').value||'ja-en';
    const dir = (speaker==='A') ? dirSel : reverseDir(dirSel);

    // 1) åŸæ–‡ï¼ˆåŒè©±è€…ï¼‰
    logMessage(speaker, text, 'åŸæ–‡');

    // 2) ç¿»è¨³
    let translated='';
    try{
      const r=await fetch('/ja/translate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text, direction:dir})});
      const j=await r.json(); translated=(j.translated||'').trim();
    }catch(e){ translated=''; }

    // 3) è¨³ï¼ˆåŒè©±è€…ï¼‰â†’ AA/BB
    if(translated){ logMessage(speaker, translated, 'è¨³'); elOut.textContent=translated; }

    // 4) ç›¸æ‰‹ã«èã‹ã›ã‚‹è¨€èªã§TTS
    try{
      const vol=(typeof window.getTTSVolume==='function')?window.getTTSVolume():6.0;
      const a=await fetch('/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text: translated||text, lang: ttsLangFrom(dir), volume: vol})});
      if(a.ok){
        const b=await a.blob(); const url=URL.createObjectURL(b);
        elAu.src=url; elAu.classList.remove('hidden');
        try{ await elAu.play(); }catch{}
      }
    }catch(e){}

    // 5) æ¬¡ã®ç•ªã¸â†’Bã®ã‚¯ã‚¤ãƒƒã‚¯è¿”ç­”/AIè¿”ç­”
    currentSpeaker = (speaker==='A') ? 'B' : 'A';
    updateTurnUI();
    renderQuickReplies(currentSpeaker);

    // è‡ªå‹•AIã¯ã€ŒBã®ç•ªã®ã¨ãã ã‘ã€å‹•ã‹ã™ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰
    if (elAiAuto?.checked && currentSpeaker==='B'){
      setTimeout(()=>{ aiReplyB(); }, 400);
    }
  }
  </script>

  <!-- æ—¢å­˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆå¾“æ¥ã®ä¸€æ–¹å‘ç¿»è¨³ã‚‚ç¶­æŒï¼‰ -->
  <script>
  function renderTemplates(){
    const items=(document.getElementById('tx-mode').value==='tour')?TPL_TOUR:TPL_LANG;
    const box=document.getElementById('tx-templates'); box.innerHTML='';
    items.forEach(s=>{
      const btn=document.createElement('button');
      btn.className='chip'; btn.textContent=s;
      btn.onclick=()=>{ document.getElementById('tx-input').value=s.replace(/ï¼ˆ.*?ï¼‰/,''); document.getElementById('tx-translate').click(); };
      box.appendChild(btn);
    });
  }

  async function translateAndSpeak(text, dir){
    if(!text) return;
    document.getElementById('tx-out').textContent='ç¿»è¨³ä¸­â€¦';
    try{
      const r=await fetch('/ja/translate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text, direction:dir})});
      if(!r.ok) throw new Error('translate '+r.status);
      const j=await r.json(); const t=(j.translated||'').trim();
      document.getElementById('tx-out').textContent=t||'ï¼ˆè¨³æ–‡ãªã—ï¼‰';

      if(t){
        try{
          const vol=(typeof window.getTTSVolume==='function')?window.getTTSVolume():6.0;
          const a=await fetch('/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:t, lang:ttsLangFrom(dir), volume: vol})});
          if(a.ok){
            const b=await a.blob(); const url=URL.createObjectURL(b);
            const au=document.getElementById('tx-audio'); au.src=url; au.classList.remove('hidden');
            try{ await au.play(); }catch{}
          }
        }catch{}
      }
    }catch(e){ console.error(e); document.getElementById('tx-out').textContent='ç¿»è¨³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'; }
  }

  // ãƒã‚¤ã‚¯ï¼ˆç°¡æ˜“ï¼‰
  let rec=null; const hasSR=('webkitSpeechRecognition' in window);
  document.getElementById('tx-mic').addEventListener('click',()=>{
    if(hasSR){
      if(rec){ rec.stop(); rec=null; elMicStatus.textContent=''; return; }
      const r=new webkitSpeechRecognition(); rec=r;
      r.lang=srcLangFrom(document.getElementById('tx-dir').value); r.interimResults=false; r.continuous=false;
      elMicStatus.textContent='ğŸ™ï¸ èãå–ã‚Šä¸­â€¦';
      r.onresult=(e)=>{ const s=Array.from(e.results).map(r=>r[0].transcript).join(' ').trim(); if(s){ document.getElementById('tx-input').value=s; document.getElementById('tx-translate').click(); } };
      r.onend=()=>{ elMicStatus.textContent=''; rec=null; };
      r.onerror=()=>{ elMicStatus.textContent=''; rec=null; };
      r.start();
    }else{ document.getElementById('tx-file').click(); }
  });

  document.getElementById('tx-file').addEventListener('change',async()=>{
    const file=document.getElementById('tx-file').files&&document.getElementById('tx-file').files[0]; if(!file)return;
    elMicStatus.textContent='ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦';
    try{
      const fd=new FormData(); fd.append('audio',file);
      const res=await fetch('/stt',{method:'POST',body:fd}); const j=await res.json();
      const s=(j.text||'').trim(); if(s){ document.getElementById('tx-input').value=s; document.getElementById('tx-translate').click(); }
    }catch{ elMicStatus.textContent='âŒ æ–‡å­—èµ·ã“ã—å¤±æ•—'; return; }
    elMicStatus.textContent=''; document.getElementById('tx-file').value='';
  });

  // çµç·š
  document.getElementById('tx-show-templates').addEventListener('click', renderTemplates);

  // ã€Œç¿»è¨³ã—ã¦è¡¨ç¤ºã€â†’ ç¾åœ¨ã®ç•ªã§å¾€å¾©ãƒ•ãƒ­ãƒ¼
  document.getElementById('tx-translate').addEventListener('click',()=>{
    const text = document.getElementById('tx-input').value.trim();
    if (!text) return;
    if (document.getElementById('send-as-a')) {
      addTurnAndSpeakLocal(currentSpeaker || 'A', text);
      return;
    }
    translateAndSpeak(text, document.getElementById('tx-dir').value || 'ja-en');
  });

  // A/Bé€ä¿¡
  document.getElementById('send-as-a')?.addEventListener('click', ()=> {
    const t=document.getElementById('tx-input')?.value?.trim(); if(!t) return;
    currentSpeaker='A'; addTurnAndSpeakLocal('A', t); document.getElementById('tx-input').value='';
  });
  document.getElementById('send-as-b')?.addEventListener('click', ()=> {
    const t=document.getElementById('tx-input')?.value?.trim(); if(!t) return;
    currentSpeaker='B'; addTurnAndSpeakLocal('B', t); document.getElementById('tx-input').value='';
  });

  // ğŸ¤–AIã§è¿”ç­”ï¼ˆBï¼‰
  document.getElementById('ai-reply')?.addEventListener('click', ()=> aiReplyB());

  // éŸ³é‡
  const volRange = document.getElementById("volumeRange");
  const volVal = document.getElementById("volumeVal");
  if(volRange && volVal){
    volRange.addEventListener("input", () => { volVal.textContent = volRange.value; });
    window.getTTSVolume = () => parseFloat(volRange.value || "0");
  }

  // Ctrl/âŒ˜+Enter é€ä¿¡
  document.getElementById('tx-input').addEventListener('keydown',(e)=>{ if(e.key==='Enter'&&(e.ctrlKey||e.metaKey)){ e.preventDefault(); document.getElementById('tx-translate').click(); } });

  // åˆæœŸè¡¨ç¤º
  updateTurnUI();
  renderQuickReplies('A'); // åˆæœŸã¯Aã®ç•ª
  </script>
</body>
</html>
