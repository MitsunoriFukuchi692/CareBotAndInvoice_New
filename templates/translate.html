<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç¿»è¨³å­¦ç¿’ï¼è¦³å…‰æ¡ˆå†…</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    .wrap{max-width:900px;margin:0 auto;padding:12px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:8px 0}
    .templates{display:flex;flex-wrap:wrap;gap:6px;margin:6px 0}
    .out{font-size:1.6rem;line-height:1.6;border:1px solid #ddd;border-radius:8px;padding:12px;min-height:3.2em}
    .hidden{display:none!important}
    .btn{padding:.5rem .8rem;border:1px solid #ccc;border-radius:8px;background:#fff}
    .btn:active{transform:scale(.98)}
    textarea{width:100%;min-height:72px}
    #tx-mic-status{min-width:8em}
  </style>
</head>
<body>
  <div class="wrap">
    <nav style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <a class="btn" href="/">â† ä»‹è­·ãƒœãƒƒãƒˆã¸æˆ»ã‚‹</a>
      <a class="btn" href="/daily_report" target="_blank" rel="noopener">ğŸ“ è¦‹å®ˆã‚Šãƒ¬ãƒãƒ¼ãƒˆ</a>
    </nav>

    <h2>ç¿»è¨³å­¦ç¿’ï¼è¦³å…‰æ¡ˆå†…</h2>

    <div class="toolbar">
      <label>ãƒ¢ãƒ¼ãƒ‰:
        <select id="tx-mode">
          <option value="lang" selected>ç¿»è¨³å­¦ç¿’</option>
          <option value="tour">è¦³å…‰æ¡ˆå†…</option>
        </select>
      </label>
      <label>ç¿»è¨³æ–¹å‘:
        <select id="tx-dir">
          <option value="ja-en" selected>æ—¥æœ¬èªâ†’è‹±èª</option>
          <option value="en-ja">è‹±èªâ†’æ—¥æœ¬èª</option>
          <option value="ja-vi">æ—¥æœ¬èªâ†’ãƒ™ãƒˆãƒŠãƒ èª</option>
          <option value="vi-ja">ãƒ™ãƒˆãƒŠãƒ èªâ†’æ—¥æœ¬èª</option>
          <option value="ja-tl">æ—¥æœ¬èªâ†’ã‚¿ã‚¬ãƒ­ã‚°èª</option>
          <option value="tl-ja">ã‚¿ã‚¬ãƒ­ã‚°èªâ†’æ—¥æœ¬èª</option>
        </select>
      </label>
      <button id="tx-show-templates" class="btn">ãƒ†ãƒ³ãƒ—ãƒ¬è¡¨ç¤º</button>
      <button id="tx-translate" class="btn">ç¿»è¨³ã—ã¦è¡¨ç¤º</button>
      <button id="tx-mic" class="btn">ğŸ¤ ãƒã‚¤ã‚¯</button>
      <span id="tx-mic-status"></span>
      <!-- iOS/Safariå‘ã‘ï¼šéŒ²éŸ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§STTã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ -->
      <input id="tx-file" type="file" accept="audio/*" capture class="hidden" />
    </div>

    <div id="tx-templates" class="templates"></div>

    <label for="tx-input">è©±ã™å†…å®¹</label>
    <textarea id="tx-input" placeholder="ä¾‹ï¼šãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€‚ä»Šæ—¥ã¯ã©ã“ã¸è¡Œãã¾ã™ã‹ï¼Ÿ"></textarea>

    <h3>è¨³æ–‡</h3>
    <div id="tx-out" class="out"></div>
    <audio id="tx-audio" controls playsinline class="hidden"></audio>
    <span id="tx-audio-hint"></span>
  </div>

  <script>
  // ==== ç°¡æ˜“ãƒ†ãƒ³ãƒ—ãƒ¬ ====
  const TPL_LANG = [
    "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼ˆGood morningï¼‰",
    "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ˆThank youï¼‰",
    "ã‚†ã£ãã‚Šè©±ã—ã¦ãã ã•ã„ï¼ˆPlease speak slowlyï¼‰",
    "ã‚‚ã†ä¸€åº¦ãŠé¡˜ã„ã—ã¾ã™ï¼ˆOne more time, pleaseï¼‰",
  ];
  const TPL_TOUR = [
    "é§…ã¯ã©ã¡ã‚‰ã§ã™ã‹ï¼Ÿ",
    "ã“ã®è¿‘ãã®ãŠã™ã™ã‚ã¯ï¼Ÿ",
    "ã„ãã‚‰ã§ã™ã‹ï¼Ÿã‚«ãƒ¼ãƒ‰ã¯ä½¿ãˆã¾ã™ã‹ï¼Ÿ",
    "åŠ©ã‘ã¦ãã ã•ã„ã€‚é“ã«è¿·ã„ã¾ã—ãŸã€‚",
  ];
  const $ = (id)=>document.getElementById(id);
  const elIn  = $('tx-input');
  const elOut = $('tx-out');
  const elAu  = $('tx-audio');
  const elHint = $('tx-audio-hint');
  const elMic = $('tx-mic');
  const elMicStatus = $('tx-mic-status');
  const elFile = $('tx-file');

  function ttsLangFrom(pair){
    const p=(pair||'ja-en').toLowerCase();
    if(p==='ja-en')return'en-US';
    if(p==='en-ja')return'ja-JP';
    if(p==='ja-vi')return'vi-VN';
    if(p==='vi-ja')return'ja-JP';
    if(p==='ja-tl')return'fil-PH';
    if(p==='tl-ja')return'ja-JP';
    return'ja-JP';
  }
  function srcLangFrom(dir){
    const p=(dir||'ja-en').toLowerCase();
    if(p==='ja-en'||p==='ja-vi'||p==='ja-tl') return 'ja-JP';
    if(p==='en-ja') return 'en-US';
    if(p==='vi-ja') return 'vi-VN';
    if(p==='tl-ja') return 'fil-PH';
    return 'ja-JP';
  }

  async function translateAndSpeak(text, dir){
    if(!text) return;
    elOut.textContent = 'ç¿»è¨³ä¸­â€¦';
    try{
      // ç¿»è¨³ï¼ˆã‚µãƒ¼ãƒã¯ JSON ã§ {translated: "..."} ã‚’è¿”ã™æƒ³å®šï¼‰
      const r = await fetch('/ja/translate', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ text, direction: dir })
      });
      if(!r.ok) throw new Error('translate '+r.status);
      const j = await r.json();
      const t = (j.translated||'').trim();
      elOut.textContent = t || 'ï¼ˆè¨³æ–‡ãªã—ï¼‰';

      // èª­ã¿ä¸Šã’ï¼ˆè‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸã‚‰ãƒ’ãƒ³ãƒˆã‚’å‡ºã™ï¼‰
      if(t){
        const a = await fetch('/tts', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text: t, lang: ttsLangFrom(dir) })
        });

        if(!a.ok){
          elAu.classList.add('hidden');
          if (elHint) elHint.textContent = 'éŸ³å£°ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ'+a.status+'ï¼‰';
          return;
        }

        const b  = await a.blob();
        const url = URL.createObjectURL(b);
        elAu.src = url;
        elAu.classList.remove('hidden');
        if (elHint){ elHint.textContent = ''; elHint.onclick = null; elHint.style.cursor=''; }

        try {
          await elAu.play();
        } catch (e) {
          // Autoplayãƒ–ãƒ­ãƒƒã‚¯ï¼šã‚¿ãƒƒãƒ—ã§å†ç”Ÿã§ãã‚‹å°ç·šã‚’å‡ºã™
          if (elHint) {
            elHint.innerHTML = 'â–¶ï¸ ã‚¿ãƒƒãƒ—ã§å†ç”Ÿ';
            elHint.style.cursor = 'pointer';
            elHint.onclick = async () => {
              try { await elAu.play(); elHint.textContent=''; elHint.onclick=null; elHint.style.cursor=''; }
              catch {}
            };
          }
        }
      }
    }catch(e){
      console.error(e);
      elOut.textContent = 'ç¿»è¨³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
    }
  }

  function renderTemplates(){
    const mode = $('tx-mode').value;
    const items = (mode==='tour') ? TPL_TOUR : TPL_LANG;
    const box = $('tx-templates'); box.innerHTML = '';
    items.forEach(s=>{
      const btn = document.createElement('button');
      btn.className = 'btn'; btn.textContent = s;
      btn.onclick = ()=>{
        elIn.value = s.replace(/ï¼ˆ.*?ï¼‰/,''); // æ‹¬å¼§å†…ã®è‹±èªã¯å…¥åŠ›ã‹ã‚‰é™¤å»
        $('tx-translate').click();
      };
      box.appendChild(btn);
    });
  }

  // ===== ãƒã‚¤ã‚¯ï¼šå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶=éŸ³å£°èªè­˜ / éå¯¾å¿œ=éŒ²éŸ³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ =====
  let rec = null;
  const hasSR = ('webkitSpeechRecognition' in window);

  elMic.addEventListener('click', ()=>{
    if (hasSR){
      if (rec){ rec.stop(); rec=null; elMicStatus.textContent=''; return; }
      const r = new webkitSpeechRecognition();
      rec = r;
      r.lang = srcLangFrom($('tx-dir').value);
      r.interimResults = false; r.continuous = false;
      elMicStatus.textContent = 'ğŸ™ï¸ èãå–ã‚Šä¸­â€¦';
      r.onresult = (e)=>{
        const s = Array.from(e.results).map(r=>r[0].transcript).join(' ').trim();
        if (s){ elIn.value = s; $('tx-translate').click(); }
      };
      r.onend = ()=>{ elMicStatus.textContent=''; rec=null; };
      r.onerror = ()=>{ elMicStatus.textContent=''; rec=null; };
      r.start();
    }else{
      // iOS/Safari ç­‰ï¼šOSã®éŒ²éŸ³UIã§ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—â†’/sttã¸
      elFile.click();
    }
  });

  elFile.addEventListener('change', async ()=>{
    const file = elFile.files && elFile.files[0];
    if (!file) return;
    elMicStatus.textContent = 'ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦';
    try{
      const fd = new FormData();
      fd.append('audio', file);
      const res = await fetch('/stt', { method:'POST', body: fd });
      const j = await res.json();
      const s = (j.text||'').trim();
      if (s){ elIn.value = s; $('tx-translate').click(); }
      elMicStatus.textContent = '';
      elFile.value = ''; // åŒã˜éŒ²éŸ³ã‚’ç¶šã‘ã¦é€ã‚Œã‚‹ã‚ˆã†ã«ã‚¯ãƒªã‚¢
    }catch(e){
      console.error(e);
      elMicStatus.textContent = 'âŒ æ–‡å­—èµ·ã“ã—å¤±æ•—';
    }
  });

  // ã‚¤ãƒ™ãƒ³ãƒˆ
  $('tx-show-templates').addEventListener('click', renderTemplates);
  $('tx-translate').addEventListener('click', ()=>{
    translateAndSpeak(elIn.value.trim(), $('tx-dir').value || 'ja-en');
  });
  elIn.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); $('tx-translate').click(); }
  });
  </script>
</body>
</html>
